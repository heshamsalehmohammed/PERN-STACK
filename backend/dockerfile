# ========== Stage 1: Builder ==========
FROM node:24-alpine AS builder

# Create app directory and set it as the working directory
WORKDIR /opt/app

# Copy package files
COPY package.json package-lock.json ./

# Install dependencies (including dev and TypeScript dependencies)
RUN npm ci

# Copy the rest of the source code
COPY . .

# Build the project (assuming "build" script in package.json compiles TypeScript)
RUN npm run build

# ========== Stage 2: Runner ==========
FROM node:24-alpine AS runner

# Set NODE_ENV to production
ENV NODE_ENV=production

# Set the working directory
WORKDIR /opt/app

# Copy only production dependencies
COPY package.json package-lock.json ./
RUN npm ci --omit=dev

# Copy the compiled output from the builder stage
COPY --from=builder /opt/app/build ./build

# Expose the port where your app listens
EXPOSE 3001

# Start the application
CMD ["node", "--max-old-space-size=12288", "build/server.js"]
